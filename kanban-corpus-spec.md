# 看板コーパス (Kanban Corpus) — 仕様書

## プロジェクト概要

日本の看板（標識・貼り紙・掲示物など）の写真を収集し、言語学的分析に使えるコーパスを構築する。
MVP として GitHub Pages 上に static な viewer を公開し、テキスト検索・タグフィルタリングを可能にする。

- 対象規模: 数百枚（将来的に増加の可能性あり）
- 利用者: 自分 + 知り合いに見せる程度
- 分析は後フェーズ。まずは生テキストの全文検索ができることが目標。

---

## データ構造

### Excel (作業用)

アノテーション作業はExcelで行う。1行 = 1サブサイン。

| 列名 | 型 | 説明 | 例 |
|------|------|------|------|
| `img` | string | 画像ファイル名 | `IMG_5870.JPG` |
| `sign_idx` | int | サブサインのインデックス（0始まり）。1枚の写真内の複数看板・1枚の看板内の複数サブサイン、いずれも同列で扱う | `0` |
| `text` | string | 看板のテキスト（改行は `\n`） | `危険！\n自転車は降りて通って下さい\nCaution!` |
| `pictograms` | string | ピクトグラムの内容。`\|` 区切り。なければ `None` | `黄ダイヤ\|人\|衝突\|自転車に乗る人` |
| `language` | string | 使用言語。`\|` 区切り | `ja\|en` |
| `form` | string | 看板の物理的形態。`\|` 区切りで設置面・形態・制作方法を組み合わせる | `柵\|貼紙` |

**`form` に現れる値の例:**

設置面: `壁`, `柵`, `金網`, `シャッター`, `自立`, `チェーン`  
形態: `看板`, `貼紙`, `持ち運び`  
制作方法: `手書き` (印刷がデフォルトなので省略)

**`sign_idx` の扱い:**

- 1枚の看板に複数メッセージがある場合（例: コンポジット型の案内板）: 0, 1, 2, ...
- 1枚の写真に複数の看板が写っている場合: 同様に 0, 1, 2, ... （看板の境界は区別しない）
- `form` は看板単位の属性だが、フラットな表では全サブサインの行に同じ値を入れる

### JSON (viewer用)

ExcelからJSON変換スクリプトで生成する。同じ `img` の行を `signs` 配列にグルーピング。

```json
[
  {
    "id": "IMG_5870",
    "image": "images/IMG_5870.jpg",
    "signs": [
      {
        "text": "危険！\n自転車は降りて通って下さい\nCaution!",
        "pictograms": ["黄ダイヤ", "人", "衝突", "自転車に乗る人"],
        "language": ["ja", "en"],
        "form": ["柵", "貼紙"]
      }
    ],
    "date": "2024-03-15T14:30:00",
    "location": { "lat": 34.6851, "lng": 135.8048 },
    "tags": [],
    "notes": ""
  }
]
```

**変換ルール:**

1. 同じ `img` の行を `signs` 配列にグルーピング
2. `pictograms`, `language`, `form` の `|` 区切り文字列を配列に分割
3. `"None"` 文字列は `null` に変換（pictogramsがNoneの場合は空配列 `[]` でもよい）
4. `form` は看板単位なので `signs` の外に配置（全行同じ値のはず）
5. `date` と `location` は画像ファイルのEXIFから取得（変換スクリプトで処理）
6. `id` は拡張子を除いたファイル名
7. `image` パスは `images/` ディレクトリ配下

---

## ホスティング・デプロイ

- GitHub Pages で static サイトとしてホスト
- 画像はリポジトリに直接格納（リサイズして500KB〜1MB/枚程度に抑える）
- GitHub 推奨上限1GBに対し、数百枚なら数百MBで収まる
- 将来数千枚に増えた場合は Cloudflare R2 等への移行を検討

### リポジトリ構成（想定）

```
/
├── index.html
├── style.css
├── app.js
├── data.json          # 変換済みデータ
├── images/
│   ├── IMG_5870.jpg
│   ├── IMG_6216.jpg
│   └── ...
└── scripts/
    └── xlsx2json.py   # Excel→JSON変換スクリプト
```

---

## Viewer (フロントエンド)

### 技術選定

- 素のHTML + CSS + vanilla JS（フレームワークなし）
- ビルドステップなし。ファイルをGitHub Pagesに置くだけ
- 数百件のフィルタリング・検索はクライアントサイドで十分高速

### 機能要件

1. **全文検索**: `data.json` をfetchし、`signs` 内の `text` フィールドに対して文字列マッチ（`includes`）で検索
2. **タグフィルタリング**: `pictograms`, `language`, `form`, `tags` による絞り込み
3. **画像一覧表示**: 検索・フィルタ結果をサムネイル付きで一覧表示
4. **詳細表示**: クリックで拡大画像 + 全メタデータ表示

### 将来の拡張候補（MVPには含めない）

- 形態素解析の結果表示（中納言的なUI）
- 地図上へのプロット（locationデータ利用）
- speech act, register 等の語用論的タグ
- ピクトグラムとテキストの共起分析

---

## アノテーションパイプライン

### 手動（数十枚）

1. Excelでタグ付け
2. 変換スクリプトでJSON化

### 自動（LLM API利用、残りの大部分）

1. ローカルスクリプトで画像をLLM APIに送信
2. LLMがExcelと同じスキーマでアノテーション結果を返す
3. 結果をExcel/JSONに追記
4. 必要に応じて人手で修正

viewerとアノテーションパイプラインは完全に分離する。

### EXIF取得

- 撮影日時と位置情報（GPS座標）を画像ファイルのEXIFメタデータから取得
- iPhoneで撮影した画像には通常EXIFが含まれる
- `.HEIC` ファイルも対応が必要
- 注意: アップロード・共有時にEXIFが消えることがあるため、変換はローカルで実施

---

## 設計上の決定事項

| 決定 | 理由 |
|------|------|
| JSONLではなく1つのJSONファイル | GitHub Pagesはサーバーサイド処理なし。fetchで一括読み込みするためJSONLのstreaming処理は不要。数百件なら1ファイルで問題ない |
| Reactではなく素のHTML+JS | この規模ではReactの状態管理が活きるほど複雑ではない。ビルドステップなしでデプロイが最速 |
| `sign_idx` 一本でフラット化 | 1看板内の複数サブサインと1写真内の複数看板を区別しない。`board_idx` + `sign_idx` の2層にする複雑さに対し、実際にそのケース（1写真に複数看板×うち1つがコンポジット）が少ないため |
| 語用論的タグ (speech_act, register) は後回し | コーパスアプローチ：まず生テキストを検索可能にし、分析軸は後から追加 |
| アノテーションとviewerの分離 | viewerはread-only（GitHub Pagesの制約）。アノテーションはローカルで完結 |
| `form` をフラットなタグ的に持つ | 設置面・形態・制作方法を厳密に分離するより、`\|` 区切りで柔軟に組み合わせるほうが実用的 |

